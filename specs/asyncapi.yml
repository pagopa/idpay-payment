asyncapi: 2.0.0
info:
  title: Payment Service
  version: 1.0.0
  description: >-
    Its purpose is to notify other systems of transaction confirmation and cancellation events and any    
    errors
tags:
  - name: "tkm"
    description: "Token manager related"
  - name: "enrollment"
    description: "Payment instruments enroll related"
  - name: "export"
    description: "Acquirer file export related"

channels:
  payment-confirm-transaction:
    subscribe:
      message:
        $ref: '#/components/messages/TransactionInProgressConfirmed'
      bindings:
        kafka:
          topic: idpay-transaction
      tags:
        - name: "enrollment"
  payment-instrument-deleted:
    subscribe:
      message:
        $ref: '#/components/messages/PaymentInstrumentRevoked'
      bindings:
        kafka:
          topic: rtd-to-app
      tags:
        - name: "enrollment"
  payment-instrument-exported:
    subscribe:
      message:
        $ref: '#/components/messages/PaymentInstrumentExported'
      bindings:
        kafka:
          topic: rtd-to-app
      tags:
        - name: "enrollment"
        - name: "export"

components:
  messages:
    TransactionInProgressConfirmed:
      contentType: application/json
      name: TransactionInProgressConfirmed
      payload:
        $ref: "#/components/schemas/TransactionInProgressConfirmed"
    PaymentInstrumentExported:
      contentType: application/json
      description: >-
        Event sent to application when a payment instrument is successfully
        added to acquirer file.
      summary: >-
        Informs applications of the success of adding the payment insturment to
        the acquirer file
      payload:
        type: object
        properties:
          type:
            type: string
            enum:
              - PaymentInstrumentExported
            example: PaymentInstrumentExported
          data:
            type: object
            properties:
              hpan:
                $ref: '#/components/schemas/PaymentInstrumentId'
              timestamp:
                type: string
                format: date-time
                example: '2022-11-11T12:47:18.575+00:00'
    PaymentInstrumentRevoked:
      contentType: application/json
      description: >-
        Event sent to application when a payment instrument is delete from
        Payment Manager side
      summary: Informs applications of deletion of a payment instrument
      payload:
        type: object
        properties:
          type:
            type: string
            enum:
              - RevokeCard
            example: RevokeCard
          data:
            type: object
            properties:
              hpan:
                $ref: '#/components/schemas/PaymentInstrumentId'
              applications:
                type: array
                items:
                  $ref: '#/components/schemas/Application'
                example:
                  - ID_PAY
                  - FA
              timestamp:
                type: string
                format: date-time
                example: '2022-11-11T12:47:18.575+00:00'
    TokenManagerUpdate:
      contentType: application/json
      description: "Emit when a par is discovered or a new token or when a payment instrument is revoked"
      payload:
        $ref: '#/components/schemas/TokenManagerUpdateSchema'

  schemas:
    PaymentInstrumentId:
      type: string
      example: b133a0c0e9bee3be20163d2ad31d6248db292aa6dcb1ee087a2aa50e0fc75ae2
    Application:
      type: string
      enum:
        - ID_PAY
        - FA
      example: ID_PAY
    CorrelationId:
      type: string
      example: '1234'
      description: Correlation id to corellate request to response
    TokenManagerUpdateSchema:
      type: object
      properties:
        type:
          type: string
          enum:
            - "TokenManagerCardChanged"
          example: TokenManagerCardChanged
        data:
          type: object
          properties:
            hashPan:
              $ref: '#/components/schemas/PaymentInstrumentId'
            taxCode:
              type: string
              example: "AABBC123SAD"
            par:
              type: string
              example: "asmdfkemasd241"
            changeType:
              type: string
              enum:
                - "INSERT_UPDATE"
                - "REVOKE"
            timestamp:
              type: string
              format: date-time
            hashTokens:
              type: array
              items:
                type: object
                properties:
                  hashToken:
                    type: string
                    example: "03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4"
                  changeType:
                    type: string
                    enum:
                      - "INSERT_UPDATE"
                      - "DELETED"
    Reward:
      type: object
      properties:
        initiativeId:
          type: string
        organizationId:
          type: string
        providedReward:
          type: integer
        accruedReward:
          type: integer
        capped:
          type: boolean
        dailyCapped:
          type: boolean
        monthlyCapped:
          type: boolean
        yearlyCapped:
          type: boolean
        weeklyCapped:
          type: boolean
        refund:
          type: boolean
        completeRefund:
          type: boolean
        counters:
          $ref: "#/components/schemas/Counter"

    Counter:
      type: object
      properties:
        trxNumber:
          type: integer
        totalReward:
          type: integer
        totalAmount:
          type: integer
        exhaustedBudget:
          type: boolean
        initiativeBudget:
          type: integer
        version:
          type: integer

    TransactionInProgressConfirmed:
      type: object
      properties:
        id:
          type: string
          description: ID of the reward transaction
        trxCode:
          type: string
          description: Transaction code
        idTrxAcquirer:
          type: string
          description: ID of the acquiring trx
        trxDate:
          type: string
          format: date-time
          description: Transaction date
        trxChargeDate:
          type: string
          format: date-time
          description: Transaction charge date
        elaborationDateTime:
          type: string
          format: date-time
          description: Elaboration date and time
        operationType:
          type: string
          description: Operation type code
        operationTypeTranscoded:
          type: string
          enum:
            - "CHARGE"
            - "REFUND"
        idTrxIssuer:
          type: string
          description: Transaction issuer ID
        correlationId:
          type: string
          description: transaction ID correlated
        amountCents:
          type: integer
          format: int64
          description: Remaining amount to be paid if the authorized sum is less than the requested sum
        effectiveAmount:
          type: number
          description: Transaction amount
        amountCurrency:
          type: string
          example: EUR
        mcc:
          type: string
          description: Merchant category code
          example: 1234
        acquirerId:
          type: string
          description: id aquirer
          example: PAGOPA
        merchantId:
          type: string
          description: id merchant
          example: b0d4c930-3f77-3959-8609-8c1e177966a0
        merchantFiscalCode:
          type: string
          description: merchant fiscal code
          example: 82186210454
        vat:
          type: string
          description: vat code of the merchant
          example: 82186210454
        initiativeId:
          type: string
          description: ID of the initiative
          example: 661626073785876cb5aa7601
        initiativeName:
          type: string
          description: Name of the initiative
          example: Initiative Name
        businessName:
          type: string
          description: The name of the merchant
          example: Esercente
        reward:
          type: integer
          format: int64
          description: Reward
          example: 30000
        counterVersion:
          type: integer
          format: int64
          description: counter version
          example: 1
        rejectionReasons:
          type: array
          description: array of rejection Reasons
          example: []
        userId:
          type: string
          description: id of user
          example: bcf3651c-d2d3-4998-81a9-5f24302ab674
        status:
          type: string
          enum:
            - REJECTED
            - REWARDED
            - CANCELLED
          description: Status of the transaction
          example: REWARDED
        channel:
          type: string
          enum:
            - RTD
            - QRCODE
            - IDPAYCODE
            - BARCODE
          description: Channel from which the transaction takes place
          example: BARCODE
        rewards:
          type: object
          additionalProperties: false
          properties:
            ${payload.properties.initiativeId}:
              $ref: "#/components/schemas/Reward"
